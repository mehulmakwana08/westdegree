<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Contact Management - Portfolio Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/admin-responsive.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }
        
        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .bg-primary-gradient {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }
        
        .bg-success-gradient {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .bg-warning-gradient {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }
        
        .bg-info-gradient {
            background: linear-gradient(135deg, #17a2b8, #6f42c1);
        }
        
        .contact-preview {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 575.98px) {
            .stats-card .d-flex {
                flex-direction: column;
                text-align: center;
            }
            
            .stats-icon {
                margin: 0 auto 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Toggle Button -->
    <button class="btn btn-primary d-lg-none mobile-toggle" type="button" id="sidebarToggle" aria-label="Toggle navigation">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Overlay for mobile -->
    <div class="sidebar-overlay d-lg-none" id="sidebarOverlay"></div>
    
    <!-- Sidebar -->
    <%- include('sidebar') %>
    <!-- Main Content -->
    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Contact Management</h1>
            <div>
                <button class="btn btn-success me-2" onclick="markSelectedAsRead()">
                    <i class="fas fa-check-circle me-1"></i> Mark as Read
                </button>
                <button class="btn btn-danger" onclick="deleteSelected()">
                    <i class="fas fa-trash me-1"></i> Delete
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-primary-gradient me-3">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div>
                            <p class="text-muted mb-0">Total Contacts</p>
                            <h3><%= stats.total %></h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-info-gradient me-3">
                            <i class="fas fa-envelope-open"></i>
                        </div>
                        <div>
                            <p class="text-muted mb-0">Read Messages</p>
                            <h3><%= stats.read %></h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-warning-gradient me-3">
                            <i class="fas fa-envelope-square"></i>
                        </div>
                        <div>
                            <p class="text-muted mb-0">Unread Messages</p>
                            <h3><%= stats.unread %></h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-success-gradient me-3">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div>
                            <p class="text-muted mb-0">Last 7 Days</p>
                            <h3><%= stats.lastWeek %></h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <% if (success) { %>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i> Contact marked as read successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        <% } %>

        <% if (updated) { %>
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle me-2"></i> Contact status updated successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        <% } %>

        <% if (deleted) { %>
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="fas fa-trash-alt me-2"></i> Contact deleted successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        <% } %>

        <% if (errorMessage) { %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i> Error: <%= errorMessage %>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        <% } %>

        <!-- Filters -->
        <div class="filter-section">
            <form method="GET" action="/admin/contacts" class="row g-3">
                <div class="col-md-3">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">All</option>
                        <option value="read" <%= typeof filter !== 'undefined' && filter.status === 'read' ? 'selected' : '' %>>Read</option>
                        <option value="unread" <%= typeof filter !== 'undefined' && filter.status === 'unread' ? 'selected' : '' %>>Unread</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="sort" class="form-label">Sort By</label>
                    <select class="form-select" id="sort" name="sort">
                        <option value="newest" <%= typeof filter !== 'undefined' && filter.sort === 'newest' ? 'selected' : '' %>>Newest First</option>
                        <option value="oldest" <%= typeof filter !== 'undefined' && filter.sort === 'oldest' ? 'selected' : '' %>>Oldest First</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="search" class="form-label">Search</label>
                    <input type="text" class="form-control" id="search" name="search" placeholder="Name, email, or message..." value="<%= typeof filter !== 'undefined' && filter.search ? filter.search : '' %>">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter me-1"></i> Apply Filters
                    </button>
                </div>
            </form>
        </div>

        <!-- Contacts Table -->
        <div class="table-responsive">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Contact Messages</h5>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    <label class="form-check-label" for="selectAll">Select All</label>
                </div>
            </div>
            
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th width="40">
                            <input class="form-check-input" type="checkbox" id="selectAllHeader" onchange="toggleSelectAll()">
                        </th>
                        <th width="180">Sender</th>
                        <th>Message</th>
                        <th width="120">Date</th>
                        <th width="80">Status</th>
                        <th width="120">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (contacts.length > 0) { %>
                        <% contacts.forEach(contact => { %>
                            <tr class="<%= !contact.isRead ? 'table-light fw-bold' : '' %>">
                                <td data-label="Select">
                                    <input class="form-check-input contact-checkbox" type="checkbox" value="<%= contact._id %>">
                                </td>
                                <td data-label="Sender">
                                    <%= contact.firstName %> <%= contact.lastName %><br>
                                    <small class="text-muted"><%= contact.email %></small>
                                </td>
                                <td data-label="Message">
                                    <div class="contact-preview">
                                        <%= contact.message.substring(0, 100) %><%= contact.message.length > 100 ? '...' : '' %>
                                    </div>
                                </td>
                                <td data-label="Date">
                                    <%= new Date(contact.createdAt).toLocaleDateString() %>
                                </td>
                                <td data-label="Status">
                                    <span class="badge <%= contact.isRead ? 'bg-success' : 'bg-warning text-dark' %>">
                                        <%= contact.isRead ? 'Read' : 'Unread' %>
                                    </span>
                                </td>
                                <td data-label="Actions">
                                    <a href="/admin/contacts/<%= contact._id %>" class="btn btn-sm btn-primary me-1">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button class="btn btn-sm btn-danger" onclick="deleteContact('<%= contact._id %>')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <i class="fas fa-inbox fa-2x mb-3 text-muted"></i>
                                <p class="mb-0">No contacts found</p>
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
            
            <!-- Pagination -->
            <% if (pagination.total > 1) { %>
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        <% if (pagination.current > 1) { %>
                            <li class="page-item">
                                <a class="page-link" href="/admin/contacts?page=<%= pagination.current - 1 %>&status=<%= typeof filter !== 'undefined' ? filter.status : '' %>&sort=<%= typeof filter !== 'undefined' ? filter.sort : 'newest' %>&search=<%= typeof filter !== 'undefined' ? filter.search : '' %>" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        <% } %>
                        
                        <% for(let i = 1; i <= pagination.total; i++) { %>
                            <li class="page-item <%= pagination.current === i ? 'active' : '' %>">
                                <a class="page-link" href="/admin/contacts?page=<%= i %>&status=<%= typeof filter !== 'undefined' ? filter.status : '' %>&sort=<%= typeof filter !== 'undefined' ? filter.sort : 'newest' %>&search=<%= typeof filter !== 'undefined' ? filter.search : '' %>">
                                    <%= i %>
                                </a>
                            </li>
                        <% } %>
                        
                        <% if (pagination.current < pagination.total) { %>
                            <li class="page-item">
                                <a class="page-link" href="/admin/contacts?page=<%= pagination.current + 1 %>&status=<%= typeof filter !== 'undefined' ? filter.status : '' %>&sort=<%= typeof filter !== 'undefined' ? filter.sort : 'newest' %>&search=<%= typeof filter !== 'undefined' ? filter.search : '' %>" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        <% } %>
                    </ul>
                </nav>
            <% } %>
        </div>
    </div>

    <!-- Contact Details Modal -->
    <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contactModalLabel">Contact Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="contactDetails">
                        <p class="text-center">
                            <span class="spinner-border text-primary"></span>
                            <br>Loading contact details...
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="markAsReadBtn" onclick="markContactAsRead()">
                        <i class="fas fa-check-circle me-1"></i> Mark as Read
                    </button>
                </div>
            </div>
        </div>
    </div>    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/admin-responsive.js"></script>
    <script>
        let currentContactId = null;

        // Select all functionality
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll') || document.getElementById('selectAllHeader');
            const checkboxes = document.querySelectorAll('.contact-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        // Mark selected contacts as read
        function markSelectedAsRead() {
            const selectedCheckboxes = document.querySelectorAll('.contact-checkbox:checked');
            const contactIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            if (contactIds.length === 0) {
                alert('Please select at least one contact to mark as read.');
                return;
            }
            
            if (confirm(`Mark ${contactIds.length} contact(s) as read?`)) {
                // Create a form and submit it
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/admin/contacts/mark-selected-as-read';
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'contactIds';
                input.value = JSON.stringify(contactIds);
                
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        // Delete selected contacts
        function deleteSelected() {
            const selectedCheckboxes = document.querySelectorAll('.contact-checkbox:checked');
            const contactIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            if (contactIds.length === 0) {
                alert('Please select at least one contact to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${contactIds.length} contact(s)? This action cannot be undone.`)) {
                // Create a form and submit it
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/admin/contacts/delete-selected';
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'contactIds';
                input.value = JSON.stringify(contactIds);
                
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        }

        // View contact details
        function viewContact(contactId) {
            currentContactId = contactId;
            fetch(`/api/contacts/${contactId}`)
                .then(response => response.json())
                .then(data => {
                    const contactDetails = document.getElementById('contactDetails');
                    const contactDate = new Date(data.createdAt).toLocaleString();
                    
                    // Format the contact details HTML
                    let html = `
                        <div class="mb-3">
                            <h5 class="mb-1">${data.firstName} ${data.lastName}</h5>
                            <p class="text-muted mb-0">
                                <i class="fas fa-envelope me-1"></i> ${data.email}
                                ${data.phone ? `<br><i class="fas fa-phone me-1"></i> ${data.phone}` : ''}
                            </p>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Subject</h6>
                            <p>${data.subject || 'No subject'}</p>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Message</h6>
                            <p>${data.message}</p>
                        </div>
                        
                        <div class="d-flex justify-content-between text-muted">
                            <small>
                                <i class="fas fa-calendar me-1"></i> ${contactDate}
                            </small>
                            <span class="badge ${data.isRead ? 'bg-success' : 'bg-warning text-dark'}">
                                ${data.isRead ? 'Read' : 'Unread'}
                            </span>
                        </div>
                    `;
                    
                    contactDetails.innerHTML = html;
                    
                    // Show/hide mark as read button
                    const markAsReadBtn = document.getElementById('markAsReadBtn');
                    if (data.isRead) {
                        markAsReadBtn.style.display = 'none';
                    } else {
                        markAsReadBtn.style.display = 'block';
                    }
                    
                    const modal = new bootstrap.Modal(document.getElementById('contactModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error fetching contact details:', error);
                    alert('Error loading contact details. Please try again.');
                });
        }

        // Delete a single contact
        function deleteContact(contactId) {
            if (confirm('Are you sure you want to delete this contact? This action cannot be undone.')) {
                // Create a form and submit it
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/admin/contacts/${contactId}/delete`;
                document.body.appendChild(form);
                form.submit();
            }
        }

        async function markAsRead(id) {
            try {
                const response = await fetch(`/admin/contacts/${id}/mark-as-read`, {
                    method: 'POST',
                });
                
                if (response.ok) {
                    window.location.reload();
                } else {
                    const data = await response.json();
                    alert('Error marking contact as read: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error marking contact as read:', error);
                alert('Error marking contact as read. Please try again.');
            }
        }

        async function markContactAsRead() {
            if (currentContactId) {
                await markAsRead(currentContactId);
                const modal = bootstrap.Modal.getInstance(document.getElementById('contactModal'));
                modal.hide();
            }
        }
    </script>
</body>
</html>
